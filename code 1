#include <WiFi.h>
#include <WebServer.h>
#include <SPIFFS.h>
#include <SPI.h>
#include <MFRC522.h>

// WiFi instellingen - PAS DIT AAN!
const char* ssid = "bletchley";
const char* password = "laptop!internet";
const char* adminPassword = "admin123";

WebServer server(80);

// RFID instellingen
#define RST_PIN 21
#define SS_PIN 5
#define LED_PIN 12

MFRC522 mfrc522(SS_PIN, RST_PIN);

// Variabelen voor kaartkoppeling
bool linkingMode = false;
String userToLink = "";
unsigned long linkingStartTime = 0;
const unsigned long LINKING_TIMEOUT = 30000;

// Logboek instellingen
const int MAX_LOG_ENTRIES = 1000;
const unsigned long LOG_RETENTION_DAYS = 30;

// Eenvoudige functie om gebruikers op te slaan
void addUser(const String& user) {
  if(user.length() == 0) {
    logMessage("SYSTEM", "Lege gebruikersnaam, niet toegevoegd");
    return;
  }
  
  File file = SPIFFS.open("/users.txt", FILE_APPEND);
  if(!file){
    logMessage("SYSTEM", "Fout bij openen users.txt");
    return;
  }
  
  if(file.println(user)){
    logMessage("USER_ADD", "Gebruiker toegevoegd: " + user);
  } else {
    logMessage("SYSTEM", "Fout bij schrijven gebruiker");
  }
  file.close();
}

// Gebruiker verwijderen
void removeUser(const String& user) {
  if(user.length() == 0) {
    logMessage("SYSTEM", "Lege gebruikersnaam, niet verwijderd");
    return;
  }
  
  File file = SPIFFS.open("/users.txt", FILE_READ);
  if(!file) {
    logMessage("SYSTEM", "Geen users.txt bestand gevonden");
    return;
  }

  String content;
  bool userFound = false;
  
  while(file.available()){
    String line = file.readStringUntil('\n');
    line.trim();
    if(line != user && line.length() > 0){
      content += line + "\n";
    } else if(line == user) {
      userFound = true;
    }
  }
  file.close();

  file = SPIFFS.open("/users.txt", FILE_WRITE);
  if(file){
    file.print(content);
    file.close();
    if(userFound) {
      logMessage("USER_REMOVE", "Gebruiker verwijderd: " + user);
    } else {
      logMessage("SYSTEM", "Gebruiker niet gevonden: " + user);
    }
  } else {
    logMessage("SYSTEM", "Fout bij openen users.txt voor schrijven");
  }
}

// Check of gebruiker bestaat
bool userExists(const String& user) {
  if(user.length() == 0) return false;
  
  File file = SPIFFS.open("/users.txt", FILE_READ);
  if(!file) {
    return false;
  }

  bool exists = false;
  while(file.available()){
    String line = file.readStringUntil('\n');
    line.trim();
    if(line == user){
      exists = true;
      break;
    }
  }
  file.close();
  return exists;
}

// Kaart UID naar String converteren
String getUIDString() {
  String uidString = "";
  for (byte i = 0; i < mfrc522.uid.size; i++) {
    if (mfrc522.uid.uidByte[i] < 0x10) {
      uidString += "0";
    }
    uidString += String(mfrc522.uid.uidByte[i], HEX);
  }
  uidString.toUpperCase();
  return uidString;
}

// Kaart toevoegen aan gebruiker
void addCardToUser(const String& user, const String& cardUID) {
  File file = SPIFFS.open("/cards.txt", FILE_APPEND);
  if(!file){
    logMessage("SYSTEM", "Fout bij openen cards.txt");
    return;
  }
  
  String line = user + "=" + cardUID;
  if(file.println(line)){
    logMessage("CARD_LINK", "Kaart gekoppeld: " + cardUID + " -> " + user);
  } else {
    logMessage("SYSTEM", "Fout bij schrijven kaart");
  }
  file.close();
}

// Gebruiker zoeken bij kaart UID
String getUserByCard(const String& cardUID) {
  File file = SPIFFS.open("/cards.txt", FILE_READ);
  if(!file) {
    return "";
  }

  while(file.available()){
    String line = file.readStringUntil('\n');
    line.trim();
    int separator = line.indexOf('=');
    if(separator != -1) {
      String storedUser = line.substring(0, separator);
      String storedCard = line.substring(separator + 1);
      if(storedCard == cardUID) {
        file.close();
        return storedUser;
      }
    }
  }
  file.close();
  return "";
}

// Kaart verwijderen bij gebruiker
void removeCardFromUser(const String& user) {
  File file = SPIFFS.open("/cards.txt", FILE_READ);
  if(!file) {
    return;
  }

  String content;
  while(file.available()){
    String line = file.readStringUntil('\n');
    line.trim();
    int separator = line.indexOf('=');
    if(separator != -1) {
      String storedUser = line.substring(0, separator);
      if(storedUser != user && line.length() > 0) {
        content += line + "\n";
      }
    }
  }
  file.close();

  file = SPIFFS.open("/cards.txt", FILE_WRITE);
  if(file){
    file.print(content);
    file.close();
    logMessage("CARD_UNLINK", "Kaarten verwijderd voor gebruiker: " + user);
  }
}

// Logboek bericht toevoegen
void logMessage(const String& category, const String& message) {
  // Timestamp
  unsigned long currentTime = millis();
  unsigned long seconds = currentTime / 1000;
  unsigned long minutes = seconds / 60;
  unsigned long hours = minutes / 60;
  unsigned long days = hours / 24;
  
  String timestamp = String(days) + "d " + 
                    String(hours % 24) + "h " + 
                    String(minutes % 60) + "m " + 
                    String(seconds % 60) + "s";
  
  String logEntry = "[" + timestamp + "] [" + category + "] " + message;
  
  // Print naar Serial
  Serial.println(logEntry);
  
  // Opslaan in logboek bestand
  File file = SPIFFS.open("/system.log", FILE_APPEND);
  if(file){
    file.println(logEntry);
    file.close();
  }
  
  // Logboek onderhoud (verwijder oude entries als nodig)
  maintainLogFile();
}

// Logboek onderhoud
void maintainLogFile() {
  File file = SPIFFS.open("/system.log", FILE_READ);
  if(!file) return;
  
  // Tel het aantal regels
  int lineCount = 0;
  while(file.available()) {
    file.readStringUntil('\n');
    lineCount++;
  }
  file.close();
  
  // Als we over het maximum zitten, verwijder oude entries
  if(lineCount > MAX_LOG_ENTRIES) {
    file = SPIFFS.open("/system.log", FILE_READ);
    if(!file) return;
    
    // Sla de eerste helft over (behoud de nieuwste helft)
    int linesToKeep = MAX_LOG_ENTRIES / 2;
    int linesToSkip = lineCount - linesToKeep;
    
    String content;
    for(int i = 0; i < linesToSkip; i++) {
      file.readStringUntil('\n');
    }
    
    while(file.available()) {
      content += file.readStringUntil('\n') + "\n";
    }
    file.close();
    
    file = SPIFFS.open("/system.log", FILE_WRITE);
    if(file) {
      file.print(content);
      file.close();
      logMessage("SYSTEM", "Logboek opgeruimd, " + String(linesToSkip) + " oude entries verwijderd");
    }
  }
}

// Toon alle gebruikers en kaarten
String listUsersAndCards() {
  File file = SPIFFS.open("/users.txt", FILE_READ);
  if(!file) {
    return "Geen gebruikers gevonden";
  }

  String userList = "Geregistreerde gebruikers en kaarten:\n\n";
  int count = 0;
  
  while(file.available()){
    String user = file.readStringUntil('\n');
    user.trim();
    if(user.length() > 0){
      userList += "üë§ " + user + "\n";
      
      File cardFile = SPIFFS.open("/cards.txt", FILE_READ);
      if(cardFile) {
        bool hasCard = false;
        while(cardFile.available()){
          String line = cardFile.readStringUntil('\n');
          line.trim();
          int separator = line.indexOf('=');
          if(separator != -1) {
            String storedUser = line.substring(0, separator);
            String storedCard = line.substring(separator + 1);
            if(storedUser == user) {
              userList += "   ü™™ Kaart: " + storedCard + "\n";
              hasCard = true;
            }
          }
        }
        cardFile.close();
        if(!hasCard) {
          userList += "   ‚ùå Geen kaart gekoppeld\n";
        }
      }
      userList += "\n";
      count++;
    }
  }
  file.close();
  
  if(count == 0) {
    return "Geen gebruikers geregistreerd";
  }
  userList += "Totaal: " + String(count) + " gebruiker(s)";
  return userList;
}

// Toon logboek
String getLogEntries(int maxEntries = 100) {
  File file = SPIFFS.open("/system.log", FILE_READ);
  if(!file) {
    return "Geen logboek gevonden";
  }

  // Tel totaal aantal regels
  int totalLines = 0;
  while(file.available()) {
    file.readStringUntil('\n');
    totalLines++;
  }
  file.close();
  
  // Lees de laatste maxEntries regels
  file = SPIFFS.open("/system.log", FILE_READ);
  String logContent = "Systeem Logboek (" + String(totalLines) + " entries totaal)\n";
  logContent += "Laatste " + String(maxEntries) + " entries:\n\n";
  
  int startLine = max(0, totalLines - maxEntries);
  for(int i = 0; i < startLine; i++) {
    file.readStringUntil('\n');
  }
  
  while(file.available()) {
    logContent += file.readStringUntil('\n') + "\n";
  }
  file.close();
  
  return logContent;
}

// Controleer beheerderswachtwoord
bool checkAdminPassword() {
  if(server.hasArg("password")){
    String pwd = server.arg("password");
    return (pwd == adminPassword);
  }
  return false;
}

// RFID kaart verwerken
void handleRFID() {
  if (!mfrc522.PICC_IsNewCardPresent()) {
    return;
  }

  if (!mfrc522.PICC_ReadCardSerial()) {
    return;
  }

  String cardUID = getUIDString();
  logMessage("RFID_SCAN", "Kaart gescand: " + cardUID);

  if (linkingMode) {
    addCardToUser(userToLink, cardUID);
    linkingMode = false;
    
    digitalWrite(LED_PIN, HIGH);
    delay(500);
    digitalWrite(LED_PIN, LOW);
    delay(200);
    digitalWrite(LED_PIN, HIGH);
    delay(500);
    digitalWrite(LED_PIN, LOW);
    
  } else {
    String user = getUserByCard(cardUID);
    if (user != "") {
      logMessage("ACCESS_GRANTED", "Toegang toegestaan voor: " + user + " (Kaart: " + cardUID + ")");
      digitalWrite(LED_PIN, HIGH);
      delay(2000);
      digitalWrite(LED_PIN, LOW);
    } else {
      logMessage("ACCESS_DENIED", "Toegang geweigerd voor kaart: " + cardUID);
      for (int i = 0; i < 3; i++) {
        digitalWrite(LED_PIN, HIGH);
        delay(200);
        digitalWrite(LED_PIN, LOW);
        delay(200);
      }
    }
  }

  mfrc522.PICC_HaltA();
}

// HTML homepage
void handleRoot() {
  String html = "<!DOCTYPE html><html><head><title>ESP32 NAC System</title>";
  html += "<meta charset='UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1.0'>";
  html += "<style>";
  html += "body{font-family:Arial,sans-serif;margin:20px;background:#f5f5f5;}";
  html += ".container{max-width:1000px;margin:0 auto;background:white;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}";
  html += "h1{color:#333;text-align:center;}";
  html += ".section{margin:20px 0;padding:15px;border:1px solid #ddd;border-radius:5px;}";
  html += "input[type='text'],input[type='password']{width:200px;padding:8px;margin:5px;border:1px solid #ccc;border-radius:4px;}";
  html += "button{background:#4CAF50;color:white;padding:10px 15px;border:none;border-radius:4px;cursor:pointer;margin:5px;}";
  html += "button:hover{background:#45a049;}";
  html += ".danger{background:#f44336;}";
  html += ".danger:hover{background:#da190b;}";
  html += ".warning{background:#ff9800;}";
  html += ".warning:hover{background:#e68900;}";
  html += ".info{background:#2196F3;}";
  html += ".info:hover{background:#0b7dda;}";
  html += ".status{background:#2196F3;color:white;padding:10px;border-radius:4px;margin:10px 0;}";
  html += ".log-entry{font-family:monospace;font-size:12px;margin:2px 0;}";
  html += ".log-timestamp{color:#666;}";
  html += ".log-category{color:#2196F3;font-weight:bold;}";
  html += ".log-message{color:#333;}";
  html += "</style></head><body>";
  html += "<div class='container'>";
  html += "<h1>ESP32 NAC Beheerpaneel</h1>";
  html += "<p><strong>IP adres: " + WiFi.localIP().toString() + "</strong></p>";
  
  if (linkingMode) {
    html += "<div class='status'>";
    html += "üîÑ <strong>Koppelmodus actief!</strong><br>";
    html += "Houd een RFID kaart bij de lezer om deze te koppelen aan: <strong>" + userToLink + "</strong><br>";
    html += "Timeout over: " + String((LINKING_TIMEOUT - (millis() - linkingStartTime)) / 1000) + " seconden";
    html += "</div>";
  }
  
  html += "<div class='section'><h2>Toegang Controleren</h2>";
  html += "<form action='/access' method='GET'>";
  html += "<input type='text' name='name' placeholder='Gebruikersnaam'>";
  html += "<button type='submit'>Toegang Controleren</button>";
  html += "</form></div>";
  
  html += "<div class='section'><h2>Gebruiker Toevoegen</h2>";
  html += "<form action='/users/add' method='GET'>";
  html += "<input type='text' name='name' placeholder='Gebruikersnaam'>";
  html += "<input type='password' name='password' placeholder='Beheerderswachtwoord'>";
  html += "<button type='submit'>Gebruiker Toevoegen</button>";
  html += "</form></div>";
  
  html += "<div class='section'><h2>RFID Kaart Koppelen</h2>";
  html += "<form action='/users/linkcard' method='GET'>";
  html += "<input type='text' name='name' placeholder='Gebruikersnaam'>";
  html += "<input type='password' name='password' placeholder='Beheerderswachtwoord'>";
  html += "<button type='submit' class='warning'>Kaart Koppelen</button>";
  html += "</form></div>";
  
  html += "<div class='section'><h2>Gebruiker Verwijderen</h2>";
  html += "<form action='/users/remove' method='GET' onsubmit='return confirm(\"Weet je het zeker?\")'>";
  html += "<input type='text' name='name' placeholder='Gebruikersnaam'>";
  html += "<input type='password' name='password' placeholder='Beheerderswachtwoord'>";
  html += "<button type='submit' class='danger'>Gebruiker Verwijderen</button>";
  html += "</form></div>";
  
  html += "<div class='section'><h2>Gebruikers & Kaarten Lijst</h2>";
  html += "<form action='/users/list' method='GET'>";
  html += "<input type='password' name='password' placeholder='Beheerderswachtwoord'>";
  html += "<button type='submit'>Toon Gebruikers & Kaarten</button>";
  html += "</form></div>";
  
  html += "<div class='section'><h2>Systeem Logboek</h2>";
  html += "<form action='/system/logs' method='GET'>";
  html += "<input type='password' name='password' placeholder='Beheerderswachtwoord'>";
  html += "<button type='submit' class='info'>Bekijk Logboek</button>";
  html += "</form>";
  html += "<form action='/system/clearlogs' method='GET' onsubmit='return confirm(\"Logboek echt wissen?\")' style='display:inline;'>";
  html += "<input type='password' name='password' placeholder='Beheerderswachtwoord'>";
  html += "<button type='submit' class='danger'>Wis Logboek</button>";
  html += "</form></div>";
  
  html += "</div></body></html>";
  
  server.send(200, "text/html", html);
}

void handleAccess() {
  if(server.hasArg("name")){
    String user = server.arg("name");
    user.trim();
    
    if(user.length() == 0) {
      server.send(400, "text/plain", "Lege gebruikersnaam!");
      return;
    }
    
    if(userExists(user)){
      server.send(200, "text/plain", "‚úÖ Toegang toegestaan voor: " + user);
    } else {
      server.send(403, "text/plain", "‚ùå Toegang geweigerd voor: " + user);
    }
  } else {
    server.send(400, "text/plain", "Geen gebruikersnaam opgegeven!");
  }
}

void handleAddUser() {
  if(!server.hasArg("name") || !server.hasArg("password")){
    server.send(400, "text/plain", "Ongeldig verzoek! Gebruik: /users/add?name=gebruiker&password=admin123");
    return;
  }
  
  if(!checkAdminPassword()){
    server.send(401, "text/plain", "‚ùå Niet geautoriseerd! Ongeldig wachtwoord.");
    return;
  }
  
  String user = server.arg("name");
  user.trim();
  
  if(user.length() == 0) {
    server.send(400, "text/plain", "Lege gebruikersnaam!");
    return;
  }
  
  if(userExists(user)){
    server.send(409, "text/plain", "‚ö†Ô∏è Gebruiker bestaat al: " + user);
  } else {
    addUser(user);
    server.send(200, "text/plain", "‚úÖ Gebruiker toegevoegd: " + user + "\n\nJe kunt nu een RFID kaart koppelen via 'RFID Kaart Koppelen'");
  }
}

void handleLinkCard() {
  if(!server.hasArg("name") || !server.hasArg("password")){
    server.send(400, "text/plain", "Ongeldig verzoek! Gebruik: /users/linkcard?name=gebruiker&password=admin123");
    return;
  }
  
  if(!checkAdminPassword()){
    server.send(401, "text/plain", "‚ùå Niet geautoriseerd! Ongeldig wachtwoord.");
    return;
  }
  
  String user = server.arg("name");
  user.trim();
  
  if(user.length() == 0) {
    server.send(400, "text/plain", "Lege gebruikersnaam!");
    return;
  }
  
  if(!userExists(user)){
    server.send(404, "text/plain", "‚ö†Ô∏è Gebruiker niet gevonden: " + user);
    return;
  }
  
  linkingMode = true;
  userToLink = user;
  linkingStartTime = millis();
  
  server.send(200, "text/html", 
    "<html><body style='font-family: Arial; margin: 20px;'>"
    "<h1>üîó Kaart Koppelen</h1>"
    "<div style='background: #e3f2fd; padding: 20px; border-radius: 10px;'>"
    "<h2>Koppelmodus actief!</h2>"
    "<p><strong>Gebruiker:</strong> " + user + "</p>"
    "<p>Houd nu een RFID kaart bij de lezer...</p>"
    "<p>Deze modus blijft 30 seconden actief.</p>"
    "<p><a href='/'>Terug naar hoofdpagina</a></p>"
    "</div>"
    "</body></html>"
  );
}

void handleRemoveUser() {
  if(!server.hasArg("name") || !server.hasArg("password")){
    server.send(400, "text/plain", "Ongeldig verzoek! Gebruik: /users/remove?name=gebruiker&password=admin123");
    return;
  }
  
  if(!checkAdminPassword()){
    server.send(401, "text/plain", "‚ùå Niet geautoriseerd! Ongeldig wachtwoord.");
    return;
  }
  
  String user = server.arg("name");
  user.trim();
  
  if(user.length() == 0) {
    server.send(400, "text/plain", "Lege gebruikersnaam!");
    return;
  }
  
  if(!userExists(user)){
    server.send(404, "text/plain", "‚ö†Ô∏è Gebruiker niet gevonden: " + user);
  } else {
    removeUser(user);
    removeCardFromUser(user);
    server.send(200, "text/plain", "‚úÖ Gebruiker verwijderd: " + user + " (inclusief gekoppelde kaarten)");
  }
}

void handleListUsers() {
  if(!server.hasArg("password")){
    server.send(400, "text/plain", "Wachtwoord vereist! Gebruik: /users/list?password=admin123");
    return;
  }
  
  if(!checkAdminPassword()){
    server.send(401, "text/plain", "‚ùå Niet geautoriseerd! Ongeldig wachtwoord.");
    return;
  }
  
  server.send(200, "text/plain", listUsersAndCards());
}

void handleSystemLogs() {
  if(!server.hasArg("password")){
    server.send(400, "text/plain", "Wachtwoord vereist! Gebruik: /system/logs?password=admin123");
    return;
  }
  
  if(!checkAdminPassword()){
    server.send(401, "text/plain", "‚ùå Niet geautoriseerd! Ongeldig wachtwoord.");
    return;
  }
  
  String logContent = getLogEntries(100); // Laatste 100 entries
  server.send(200, "text/plain", logContent);
}

void handleClearLogs() {
  if(!server.hasArg("password")){
    server.send(400, "text/plain", "Wachtwoord vereist! Gebruik: /system/clearlogs?password=admin123");
    return;
  }
  
  if(!checkAdminPassword()){
    server.send(401, "text/plain", "‚ùå Niet geautoriseerd! Ongeldig wachtwoord.");
    return;
  }
  
  File file = SPIFFS.open("/system.log", FILE_WRITE);
  if(file) {
    file.print("");
    file.close();
    logMessage("SYSTEM", "Logboek gewist via webinterface");
    server.send(200, "text/plain", "‚úÖ Logboek gewist");
  } else {
    server.send(500, "text/plain", "‚ùå Fout bij wissen logboek");
  }
}

void handleNotFound() {
  String message = "Pagina niet gevonden.\n\n";
  message += "Beschikbare endpoints:\n";
  message += "  GET /                       - Beheer interface\n";
  message += "  GET /access?name=USER       - Toegang controleren\n";
  message += "  GET /users/add?name=USER&password=admin123\n";
  message += "  GET /users/linkcard?name=USER&password=admin123\n";
  message += "  GET /users/remove?name=USER&password=admin123\n";
  message += "  GET /users/list?password=admin123\n";
  message += "  GET /system/logs?password=admin123\n";
  message += "  GET /system/clearlogs?password=admin123\n";
  server.send(404, "text/plain", message);
}

void setup() {
  Serial.begin(115200);
  delay(1000);

  Serial.println();
  Serial.println("=== ESP32 NAC System met RFID en Logboek ===");
  
  // SPIFFS starten
  if(!SPIFFS.begin(true)){
    Serial.println("SPIFFS kon niet starten!");
    return;
  }
  logMessage("SYSTEM", "SPIFFS gestart");

  // RFID lezer initialiseren
  pinMode(LED_PIN, OUTPUT);
  digitalWrite(LED_PIN, LOW);
  
  SPI.begin();
  mfrc522.PCD_Init();
  logMessage("SYSTEM", "RFID lezer ge√Ønitialiseerd");

  // WiFi verbinden
  logMessage("SYSTEM", "Verbinden met WiFi: " + String(ssid));
  
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() != WL_CONNECTED) {
    logMessage("SYSTEM", "WiFi verbinding mislukt!");
    return;
  }
  
  logMessage("SYSTEM", "WiFi verbonden! IP: " + WiFi.localIP().toString());

  // Server routes
  server.on("/", handleRoot);
  server.on("/access", handleAccess);
  server.on("/users/add", handleAddUser);
  server.on("/users/linkcard", handleLinkCard);
  server.on("/users/remove", handleRemoveUser);
  server.on("/users/list", handleListUsers);
  server.on("/system/logs", handleSystemLogs);
  server.on("/system/clearlogs", handleClearLogs);
  server.onNotFound(handleNotFound);

  server.begin();
  logMessage("SYSTEM", "HTTP server gestart op http://" + WiFi.localIP().toString());
  logMessage("SYSTEM", "Beheerderswachtwoord: " + String(adminPassword));
}

void loop() {
  server.handleClient();
  
  // Verwerk RFID kaarten
  handleRFID();
  
  // Timeout voor koppelmodus
  if (linkingMode && (millis() - linkingStartTime > LINKING_TIMEOUT)) {
    linkingMode = false;
    logMessage("SYSTEM", "Koppelmodus timeout - geen kaart gescand");
    
    for (int i = 0; i < 5; i++) {
      digitalWrite(LED_PIN, HIGH);
      delay(100);
      digitalWrite(LED_PIN, LOW);
      delay(100);
    }
  }
  
  delay(100);
}
